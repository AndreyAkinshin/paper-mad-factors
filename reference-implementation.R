quantile.hd <- function(x, probs) sapply(probs, function(p) {
  n <- length(x)
  if (n == 0) return(NA)
  if (n == 1) return(x)
  x <- sort(x)
  a <- (n + 1) * p; b <- (n + 1) * (1 - p)
  cdfs <- pbeta(0:n/n, a, b)
  W <- tail(cdfs, -1) - head(cdfs, -1)
  sum(x * W)
})
quantile.thd <- function(x, probs, width = 1/sqrt(length(x))) sapply(probs, function(p) {
  getBetaHdi <- function(a, b, width) {
    eps <- 1e-9
    if (a < 1 + eps & b < 1 + eps) # Degenerate case
      return(c(NA, NA))
    if (a < 1 + eps & b > 1) # Left border case
      return(c(0, width))
    if (a > 1 & b < 1 + eps) # Right border case
      return(c(1 - width, 1))
    if (width > 1 - eps)
      return(c(0, 1))
    # Middle case
    mode <- (a - 1) / (a + b - 2)
    pdf <- function(x) dbeta(x, a, b)
    l <- uniroot(
      f = function(x) pdf(x) - pdf(x + width),
      lower = max(0, mode - width),
      upper = min(mode, 1 - width),
      tol = 1e-9
    )$root
    r <- l + width
    return(c(l, r))
  }
  n <- length(x)
  if (n == 0) return(NA)
  if (n == 1) return(x)
  x <- sort(x)
  a <- (n + 1) * p; b <- (n + 1) * (1 - p)
  hdi <- getBetaHdi(a, b, width)
  hdiCdf <- pbeta(hdi, a, b)
  cdf <- function(xs) {
    xs[xs <= hdi[1]] <- hdi[1]
    xs[xs >= hdi[2]] <- hdi[2]
    (pbeta(xs, a, b) - hdiCdf[1]) / (hdiCdf[2] - hdiCdf[1])
  }
  iL <- floor(hdi[1] * n); iR <- ceiling(hdi[2] * n)
  cdfs <- cdf(iL:iR/n)
  W <- tail(cdfs, -1) - head(cdfs, -1)
  sum(x[(iL + 1):iR] * W)
})
med.sm <- function(x) median(x)
med.hd <- function(x) quantile.hd(x, 0.5)
med.thd.sqrt <- function(x) quantile.thd(x, 0.5)

factors.sm <- c(
      NA, 1.7725, 2.2049, 2.0172, 1.8040, 1.7637, 1.6871, 1.6715, 1.6326, 1.6245,
  1.6011, 1.5961, 1.5806, 1.5772, 1.5661, 1.5637, 1.5554, 1.5536, 1.5471, 1.5457,
  1.5405, 1.5393, 1.5352, 1.5342, 1.5307, 1.5299, 1.5269, 1.5263, 1.5238, 1.5233,
  1.5212, 1.5207, 1.5189, 1.5184, 1.5168, 1.5164, 1.5149, 1.5146, 1.5132, 1.5129,
  1.5117, 1.5115, 1.5103, 1.5101, 1.5091, 1.5089, 1.5080, 1.5078, 1.5069, 1.5067,
  1.5060, 1.5058, 1.5051, 1.5049, 1.5042, 1.5041, 1.5035, 1.5033, 1.5027, 1.5026,
  1.5021, 1.5019, 1.5014, 1.5013, 1.5008, 1.5007, 1.5003, 1.5002, 1.4998, 1.4997,
  1.4993, 1.4992, 1.4988, 1.4987, 1.4984, 1.4983, 1.4979, 1.4978, 1.4975, 1.4975,
  1.4972, 1.4971, 1.4968, 1.4967, 1.4965, 1.4964, 1.4961, 1.4961, 1.4958, 1.4958,
  1.4955, 1.4955, 1.4952, 1.4952, 1.4950, 1.4949, 1.4947, 1.4947, 1.4945, 1.4944)
factors.hd <- c(
      NA, 1.7725, 1.5682, 1.5959, 1.5661, 1.5666, 1.5646, 1.5591, 1.5567, 1.5529,
  1.5496, 1.5465, 1.5434, 1.5406, 1.5380, 1.5355, 1.5332, 1.5310, 1.5289, 1.5270,
  1.5252, 1.5235, 1.5220, 1.5204, 1.5191, 1.5177, 1.5164, 1.5154, 1.5143, 1.5133,
  1.5123, 1.5114, 1.5106, 1.5098, 1.5090, 1.5083, 1.5076, 1.5069, 1.5062, 1.5056,
  1.5050, 1.5045, 1.5039, 1.5034, 1.5029, 1.5025, 1.5020, 1.5016, 1.5011, 1.5008,
  1.5004, 1.5000, 1.4997, 1.4993, 1.4990, 1.4986, 1.4983, 1.4980, 1.4977, 1.4975,
  1.4972, 1.4969, 1.4967, 1.4964, 1.4962, 1.4960, 1.4957, 1.4955, 1.4953, 1.4951,
  1.4950, 1.4947, 1.4946, 1.4944, 1.4942, 1.4940, 1.4939, 1.4937, 1.4936, 1.4934,
  1.4933, 1.4931, 1.4930, 1.4928, 1.4927, 1.4926, 1.4924, 1.4923, 1.4922, 1.4921,
  1.4920, 1.4918, 1.4917, 1.4916, 1.4915, 1.4914, 1.4913, 1.4912, 1.4911, 1.4910)
factors.thd.sqrt <- c(
      NA, 1.7725, 1.6455, 2.0172, 1.6774, 1.6887, 1.6810, 1.6363, 1.6431, 1.6137,
  1.6036, 1.5938, 1.5826, 1.5771, 1.5683, 1.5639, 1.5574, 1.5530, 1.5488, 1.5449,
  1.5417, 1.5385, 1.5361, 1.5333, 1.5313, 1.5290, 1.5272, 1.5254, 1.5238, 1.5224,
  1.5210, 1.5198, 1.5185, 1.5175, 1.5163, 1.5155, 1.5144, 1.5136, 1.5127, 1.5119,
  1.5111, 1.5104, 1.5097, 1.5091, 1.5085, 1.5078, 1.5073, 1.5067, 1.5063, 1.5057,
  1.5053, 1.5048, 1.5044, 1.5039, 1.5035, 1.5031, 1.5027, 1.5024, 1.5020, 1.5017,
  1.5013, 1.5010, 1.5007, 1.5004, 1.5001, 1.4998, 1.4995, 1.4993, 1.4990, 1.4988,
  1.4986, 1.4983, 1.4981, 1.4979, 1.4977, 1.4974, 1.4972, 1.4970, 1.4969, 1.4966,
  1.4965, 1.4963, 1.4961, 1.4959, 1.4958, 1.4956, 1.4955, 1.4953, 1.4952, 1.4950,
  1.4949, 1.4947, 1.4946, 1.4944, 1.4943, 1.4942, 1.4940, 1.4940, 1.4938, 1.4937)

mad.generic <- function(med, factors, alpha, beta) function(x) {
  n <- length(x)
  factor <- ifelse(n <= 100, factors[n], 1 / qnorm(0.75) / (1 + alpha / n + beta / n^2))
  med(abs(x - med(x))) * factor
}
mad.sm <- mad.generic(med.sm, factors.sm, -0.7668, -2.1897)
mad.hd <- mad.generic(med.hd, factors.hd, -0.4912, -7.6350)
mad.thd.sqrt <- mad.generic(med.thd.sqrt, factors.thd.sqrt, -0.6954, -4.9261)
